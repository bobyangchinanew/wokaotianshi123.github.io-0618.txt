<!DOCTYPE html>
<html>
<head>
<title>Video.js 播放最快的 M3U8 视频流</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- 引入 Video.js 的 CSS -->
<link href="https://vjs.zencdn.net/7.10.4/video-js.css" rel="stylesheet" />

<style>
  #video-container {
    width: 100%;
    max-width: 800px; /* 根据需要调整 */
    margin: 20px auto; /* 留出一些边距 */
  }
</style>
</head>
<body>
<div id="video-container">
  <!-- Video.js 播放器容器 -->
  <video id="video-player" class="video-js" controls preload="auto" width="640" height="360" data-setup='{"techOrder": ["html5", "flash"]}'>
    <!-- 视频源将被动态插入这里 -->
  </video>
</div>

<!-- 引入 Video.js 的 JavaScript -->
<script src="https://vjs.zencdn.net/7.10.4/video.js"></script> 

<script>
var apiArray = [
    "https://www.ckplayer.vip/jiexi/?url=",
    "https://jx.jsonplayer.com/player/?url=",
    "https://jx.m3u8.tv/jiexi/?url=",
    "https://jx.xmflv.com/?url=",
    "https://www.8090g.cn/jiexi/?url="
];

// 从URL参数中获取视频源URL
function getVideoUrlFromParams() {
    var urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('url');
}

// 移除URL中的特殊字符
function sanitizeUrl(url) {
    return decodeURIComponent(url.replace(/'/g, '%27'));
}

var videoUrl = sanitizeUrl(getVideoUrlFromParams());
var videoPlayer = document.getElementById("video-player");
var fastestUrl = null;
var fastestTime = Infinity;

function checkUrl(url) {
    return new Promise((resolve, reject) => {
        var req = new XMLHttpRequest();
        req.open("HEAD", url, true);
        req.onreadystatechange = function() {
            if (req.readyState === 2) { // HTTP请求已接收，但服务器的响应尚未完成
                var res = req.getResponseHeader("Content-Type");
                if (res && res.includes("application/x-mpegURL")) {
                    resolve(url);
                } else {
                    reject(url);
                }
            }
        };
        req.send();
    });
}

function loadFastestVideo() {
    var startTime = performance.now();
    Promise.all(apiArray.map(api => checkUrl(api + encodeURIComponent(videoUrl))))
        .then(urls => {
            var validUrls = urls.filter(url => url !== null);
            if (validUrls.length > 0) {
                fastestUrl = validUrls.reduce((fastest, current) => {
                    var currentTime = performance.now() - startTime;
                    return (fastest === null || currentTime < fastest.currentTime) ? current : fastest;
                }, { url: null, currentTime: Infinity }).url;
                // 设置视频播放器的源
                videoPlayer.src(fastestUrl);
                videoPlayer.play();
            }
        })
        .catch(() => {
            console.error("No valid video source found.");
        });
}

// 页面加载完成后开始加载最快的视频
document.addEventListener("DOMContentLoaded", (event) => {
    loadFastestVideo();
});
</script>
</body>
</html>
